var hasTouch="ontouchstart"in document.documentElement,startEvent=hasTouch?"touchstart":"mousedown",moveEvent=hasTouch?"touchmove":"mousemove",endEvent=hasTouch?"touchend":"mouseup";if(hasTouch){$.each("touchstart touchmove touchend".split(" "),function(e,t){jQuery.event.fixHooks[t]=jQuery.event.mouseHooks});alert("has Touch")}jQuery.tableDnD={currentTable:null,dragObject:null,mouseOffset:null,oldY:0,build:function(e){var t=null;this.each(function(){this.tableDnDConfig=jQuery.extend({onDragStyle:t,onDropStyle:t,onDragClass:"tDnD_whileDrag",onDrop:t,onDragStart:t,scrollAmount:5,serializeRegexp:/[^\-]*$/,serializeParamName:t,dragHandle:t},e||{});jQuery.tableDnD.makeDraggable(this)});return this},makeDraggable:function(e){var t,n="dragHandle",r="initialiseDrag",i=e.tableDnDConfig;if(i[n])$(e).on(startEvent,i[n],function(t){jQuery.tableDnD[r](jQuery(t.target).parents("tr")[0],e,this,t,i);return!1});else{t=jQuery("tr",e);t.each(function(){var t=jQuery(this);t.hasClass("nodrag")||t.bind(startEvent,function(t){if(t.target.tagName=="TD"){jQuery.tableDnD[r](this,e,this,t,i);return!1}}).css("cursor","move")})}},initialiseDrag:function(e,t,n,r,i){var s="tableDnD",o="onDragStart";jQuery[s].dragObject=e;jQuery[s].currentTable=t;jQuery[s].mouseOffset=jQuery[s].getMouseOffset(n,r);jQuery[s].originalOrder=jQuery[s].serialize();jQuery(document).bind(moveEvent,jQuery[s].mousemove).bind(endEvent,jQuery[s].mouseup);i[o]&&i[o](t,n)},updateTables:function(){this.each(function(){this.tableDnDConfig&&jQuery.tableDnD.makeDraggable(this)})},mouseCoords:function(e){return e.pageX||e.pageY?{x:e.pageX,y:e.pageY}:{x:e.clientX+document.body.scrollLeft-document.body.clientLeft,y:e.clientY+document.body.scrollTop-document.body.clientTop}},getMouseOffset:function(e,t){var n,r;t=t||window.event;n=this.getPosition(e);r=this.mouseCoords(t);return{x:r.x-n.x,y:r.y-n.y}},getPosition:function(e){var t="offsetParent",n="offsetLeft",r=0,i=0;e.offsetHeight==0&&(e=e.firstChild);while(e[t]){r+=e[n];i+=e.offsetTop;e=e[t]}r+=e[n];i+=e.offsetTop;return{x:r,y:i}},mousemove:function(e){var t,n,r,i,s,o,u,a,f="dragObject",l="tableDnD",c="compatMode",h="undefined",p="documentElement",d="scrollAmount",v="innerHeight",m="clientHeight",g="onDragClass",y="insertBefore",b="parentNode";if(jQuery[l][f]==null)return;e.type=="touchmove"&&event.preventDefault();t=jQuery(jQuery[l][f]);n=jQuery[l].currentTable.tableDnDConfig;r=jQuery[l].mouseCoords(e);i=r.y-jQuery[l].mouseOffset.y;s=window.pageYOffset;document.all&&(typeof document[c]!=h&&document[c]!="BackCompat"?s=document[p].scrollTop:typeof document.body!=h&&(s=document.body.scrollTop));if(r.y-s<n[d])window.scrollBy(0,-n[d]);else{o=window[v]?window[v]:document[p][m]?document[p][m]:document.body[m];o-(r.y-s)<n[d]&&window.scrollBy(0,n[d])}if(i!=jQuery[l].oldY){u=i>jQuery[l].oldY;jQuery[l].oldY=i;n[g]?t.addClass(n[g]):t.css(n.onDragStyle);a=jQuery[l].findDropTargetRow(t,i);a&&(u&&jQuery[l][f]!=a?jQuery[l][f][b][y](jQuery[l][f],a.nextSibling):!u&&jQuery[l][f]!=a&&jQuery[l][f][b][y](jQuery[l][f],a))}return!1},findDropTargetRow:function(e,t){var n,r,i,s,o,u,a="currentTable",f="getPosition",l="offsetHeight",c="firstChild",h=null,p="onAllowDrop",d=jQuery.tableDnD[a].rows;for(n=0;n<d.length;n++){r=d[n];i=this[f](r).y;s=parseInt(r[l])/2;if(r[l]==0){i=this[f](r[c]).y;s=parseInt(r[c][l])/2}if(t>i-s&&t<i+s){if(r==e)return h;o=jQuery.tableDnD[a].tableDnDConfig;if(o[p])return o[p](e,r)?r:h;u=jQuery(r).hasClass("nodrop");return u?h:r}}return h},mouseup:function(e){var t,n,r,e="currentTable",i="tableDnD",s="dragObject",o="onDragClass";if(jQuery[i][e]&&jQuery[i][s]){jQuery(document).unbind(moveEvent,jQuery[i].mousemove).unbind(endEvent,jQuery[i].mouseup);t=jQuery[i][s];n=jQuery[i][e].tableDnDConfig;n[o]?jQuery(t).removeClass(n[o]):jQuery(t).css(n.onDropStyle);jQuery[i][s]=null;r=jQuery[i].serialize();n.onDrop&&n.onDrop(jQuery[i][e],t);jQuery[i][e]=null}},serialize:function(){var e="currentTable",t="tableDnD";return jQuery[t][e]?jQuery[t].serializeTable(jQuery[t][e]):"Error: No Table id set, you need to set an id on your table and every row"},serializeTable:function(e){var t,n,r="tableDnDConfig",i="serializeRegexp",s="",o=e.id,u=e.rows;for(t=0;t<u.length;t++){s.length>0&&(s+="&");n=u[t].id;n&&n&&e[r]&&e[r][i]&&(n=n.match(e[r][i])[0]);s+=o+"[]="+n}return s},serializeTables:function(){var e="";this.each(function(){e+=jQuery.tableDnD.serializeTable(this)});return e}};jQuery.fn.extend({tableDnD:jQuery.tableDnD.build,tableDnDUpdate:jQuery.tableDnD.updateTables,tableDnDSerialize:jQuery.tableDnD.serializeTables});